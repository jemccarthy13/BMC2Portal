<!DOCTYPE html>
<html>
  <head>
    <!-- CHANGE TITLE HERE -->
    <title> Lessons Learned </title>

    <!-- Required styling -->
    <link rel="stylesheet" href="/css/styles.css" />
    <link rel="stylesheet" href="/css/sidebar.css" />
    <link rel="stylesheet" href="/css/chips.css" />

    <!-- Required icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/icon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/icon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/icon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/admin/">
    <link rel="apple-touch-icon" sizes="114x114" href="/icon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/icon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/icon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="/icon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/icon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icon/favicon-16x16.png">
    <link rel="manifest" href="/icon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/icon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <!-- JAVASCRIPT INCLUDES -->
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="/js/common.js"></script>
    <script src="/js/backend.js"></script>
  </head>

  <!----------------------------------------------------------------------->
  <!--                         PAGE BODY                                 -->
  <!----------------------------------------------------------------------->
  <body>
    <!-- NAVBAR is loaded by JQUERY -->
    <div id="nav-placeholder" style="width:25%;"></div>

    <!----------------------------------------------------------------------->
    <!--                         PAGE CONTENT                              -->
    <!----------------------------------------------------------------------->

    <!----------------------------------------------------------------------->
    <!--                        TODO LIST                                  -->
    <!-- 1) Add chips to tag table                                         -->
    <!-- 2) Add a search by tags filter                                    -->
    <!-- 3) Convert to 'macro chips'/'tiles' for each lesson learned       -->
    <!-- 4) Stylize display and make it look like the storyboard/prototype -->
    <!----------------------------------------------------------------------->

    <div id="content" class="body-content">
      <div class="container">
        <h1>Search by lessons learned with Tags: </h1>
        <div class="chips-list" id="list"></div>
        <input type="text" id="txt" placeholder="type and Enter ...">
        <div id="autosuggest" class="dropdown">
        </div>
      </div>
      <br/></br>
      <div> Lessons Learned </div><br/></br>
      <table id="lessonsLearnedTable" style='width:100%'>
      </table>
    </div>
    <!-- -->
    <!-- -->
  </body>

  <script>
    // dynamically load the sidebar navigation in each page
    $(function(){
      $("#nav-placeholder").load("/sidebar.html");
    });

    //----------------------------------------------------------------------->
    //--                         PAGE SCRIPTING                            -->
    //----------------------------------------------------------------------->

    let lessons;
    let suggestedTags;

    function filterSearch(){
      filterLessons(items);
    }

    function filterLessons(tags){

      var table = document.getElementById("lessonsLearnedTable")
      table.innerHTML="";

      let lessonDisplay = lessons;
      if (tags){
        function isSuper(arr1, arr2){
          return arr2.every(function(val) { return arr1.indexOf(val.toUpperCase()) >= 0; });
        }
    
        lessonDisplay = lessonDisplay.filter(lesson => {
          lesson.tags = lesson.tags.map(m => m.toUpperCase());
          return isSuper(lesson.tags, tags)
        });
      }

      var table =document.getElementById("lessonsLearnedTable");

      if (!lessonDisplay || (lessonDisplay && lessonDisplay.length===0)){
        var row = table.insertRow();
        var cell = row.insertCell();
        cell.innerHTML = "No tags found with tags: " + tags.join(",");
      }

      lessonDisplay.forEach(lesson =>{
        // TODO - build a DOM element for each lesson learned (macro 'chip') with 'micro chips' as tags

        // for now..... stupid table
        var row = table.insertRow();
        var cell = row.insertCell();
        cell.innerHTML= lesson.date;
        var cell = row.insertCell();
        cell.innerHTML= lesson.title;
        var cell = row.insertCell();
        cell.innerHTML = lesson.tags.join(",");
      });
    }

    async function loadLessons(){
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const tags = urlParams.get('tags')
      
      console.log(tags);

      lessons = await getLessonsLearned();
      suggestedTags = await getAllTags();

      var tagSplit = [];
      if (tags){
        tagSplit = tags.split(",");
      }

      filterLessons(tagSplit);
    }

    // Populate the lessons learned
    loadLessons();

    
    //----------------------------------------------------------------------->
    //-- Chip handling. Move this to common.js to facilitate other chips?  -->
    //--      Thinking of admin/maintenance on lessons learned             -->
    //----------------------------------------------------------------------->
    var txt = document.getElementById('txt');
    var list = document.getElementById('list');
    var items = [];

    txt.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        let val = txt.value;
        if (val !== '') {
          if (items.indexOf(val) >= 0) {
            // alert('Tag name is a duplicate');
          } else {
            addChip(val);
          }
        } else {
        }
      }
    });

    function addChip(val){
      items.push(val);
      render();
      txt.value = '';
      txt.focus();
      filterLessons(items)
      document.getElementById("autosuggest").style.display=""
    }

    txt.oninput = () => {
      let dropdown = document.getElementById("autosuggest");
      
      var filteredTags = suggestedTags.filter((t) => t.indexOf(txt.value.toUpperCase()) !== -1);
      var showTags = filteredTags.slice(0,5);

      dropdown.style.display="grid";
      dropdown.innerHTML="";
      showTags.forEach((t)=>{
        elem = document.createElement('button');
        elem.onclick = ()=>addChip(t);
        elem.innerHTML=t;
        dropdown.appendChild(elem);
      })

      if (txt.value===""){
        dropdown.style.display=""
      }
    }

    function render() {
      list.innerHTML = '';
      items.map((item, index) => {
        list.innerHTML += `<li><span>${item}</span><a href="javascript: remove(${index})">X</a></li>`;
      });
    }

    function remove(i) {
      items = items.filter(item => items.indexOf(item) != i);
      filterLessons(items)
      render();
    }

    window.onload = function() {
      render();
      txt.focus();
    }
  </script>
</html>
